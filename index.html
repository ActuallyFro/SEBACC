<!-- Create page with a text area, which can be searched for the word "foundme", that is updated in a results box .innerHTML -->
<html>
<head>
<title>SEBACC - Space Engineers Block And Component Calculator</title>
</head>

<!-- load jQuery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

<!-- Load scripts on Pageload -->
  
<body>
  <h1>SEBACC - Space Engineers Block And Component Calculator</h2>
  <h2>1. Paste BluePrint Text Here</h2>
  <p>
  <!-- editable textarea, with default placeholder text 'here' -->
  <textarea id="bp-textarea" rows="10" cols="50" placeholder="Paste your SBC file contents here..."></textarea>
  </p>

  <h2>2. Press GO</h2>
  <!-- Button which runs calculateBACC() function-->
  <button onclick="calculateBACC()">GO</button>
  <p>
  </p>

  <script>
    // script function BACC(),  updates 'result' textarea with text 'example'
    function calculateBACC() {

      // //https://stackoverflow.com/questions/16991341/json-parse-file-path
      var request = new XMLHttpRequest();
      request.open("GET","Blocks.json", false);
      request.send(null);
      var jsonData = JSON.parse(request.responseText);

      // console.log(jsonData); //--debug to see if data is loaded

      var BluePrintText = $('#bp-textarea').val();

      // https://www.w3schools.com/xml/tryit.asp?filename=try_dom_loadxmltext:
      parseXMLTags= new DOMParser();
      xmlDoc = parseXMLTags.parseFromString(BluePrintText,"text/xml");

      var Blocks = [];
      var Blocks = xmlDoc.getElementsByTagName("SubtypeName");
      var BlocksCount = new Map;

      var BlocksString = "";
      var BlockCosts = new Map();
      
      for (var i = 0; i < Blocks.length; i++) {

        // Jquery based!: https://stackoverflow.com/questions/36759733/parse-json-object-in-javascript-to-get-key-and-values
        $.each(jsonData, function(keyBlock, blockData) {
          if (Blocks[i].innerHTML == keyBlock) {
            //print key to console
            console.log("=================\nFOUND BLOCK!: "+ keyBlock);


            //print costs to console:
            console.log("\nCOSTS: ");

            var MatCosts = blockData.Cost;
            // for each MatCosts, print to console:
            $.each(MatCosts, function(keyCost, componentCost) {
              //check if map value exists, if not set to 0
              if (!BlockCosts.has(keyCost)) {
                BlockCosts.set(keyCost, 0);
                console.log("[WARNING] Adding NEW material: " + keyCost);
              }

              //increment BlockCosts by val
              BlockCosts.set(keyCost, BlockCosts.get(keyCost) + componentCost);

              // console.log(key + ": " + val + "(Total: " + BlockCosts[key] + ")");
            });
          }

          // $.each(val, function(k, v) {
          //   console.log('key ='+k);
          //   console.log('value ='+v);
          // });
        });

        BlocksString += Blocks[i].innerHTML + ", ";
      }
      // remove trailing comma
      BlocksString = BlocksString.substring(0, BlocksString.length - 2);

      document.getElementById("result").innerHTML = "SUPER AWESOME BACC result; Found Blocks: {" + BlocksString + "}";

      // iterate over map and print to console:
      BlockCosts.forEach(function(value, key) {
        console.log("[INFO] " + key + ": " + value);
      });
    }
  </script>
  

  <h2>3. Profit??? (Calculation Result)</h2>
  <!-- Calculation TextArea that's updated by Javascript -->
  <textarea id="result" rows="10" cols="50" placeholder="Calculation Result"></textarea>

  <p>
  </p>


  
  </body>
</html>